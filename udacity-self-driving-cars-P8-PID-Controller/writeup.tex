\documentclass{article}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage{listings}
\usepackage[colorlinks = true,
            linkcolor = blue,
            urlcolor  = blue,
            citecolor = blue,
            anchorcolor = blue]{hyperref}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage[dvipsnames,table,xcdraw]{xcolor}
\usepackage{array}
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{M}[1]{>{\centering\arraybackslash}m{#1}}
\author{Francesco Boi}
\title{Self-driving cars program - project  8: PID controller}
\date{}

\let\cd\lstinline

\begin{document}
% Python style for highlighting

\maketitle
\tableofcontents 

\lstdefinestyle{customc}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  %frame=L,
  xleftmargin=\parindent,
  language = C++,
  showstringspaces=false,
  basicstyle=\footnotesize\ttfamily,
  keywordstyle=\bfseries\color{blue!85!black},
  commentstyle=\itshape\color{gray},
  identifierstyle=\color{black},
  stringstyle=\color{red},
  numbers=left,                    				% where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                   			% how far the line-numbers are from the code
  numberstyle=\tiny\color{gray},     % the style that is used for the line-numbers
  stepnumber=1,
  tabsize=4,
}
\lstdefinestyle{customasm}{
  belowcaptionskip=1\baselineskip,
  frame=L,
  %xleftmargin=\parindent,
  language=[x86masm]Assembler,
  basicstyle=\footnotesize\ttfamily,
  commentstyle=\itshape\color{purple!40!black},
  stepnumber=1,
   tabsize=4,
}
\definecolor{lightgray}{rgb}{.9,.9,.9}
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}
\lstset{escapechar=รง,style=customc}
\section{Content of the project}
Here is the content of the project:
\begin{itemize}
\item \textit{writeup.pdf} (this file): report of the project;
\item \textit{writeup.tex}: source tex file;
\item \textit{src}: folder containing the C++ source code of the project;
\item \textit{README.md}: file giving a general description of the project.
\end{itemize}

\section{Project goals}
The goal of this project is to tune the parameters of a PID controller that automatically drives the car in the simulator.

\section{Instruction}
Instructions to compile and run the code are included in the README.md file.

\section{Parameters tuning}
The first set of parameters has been found manually by using the PID class and the standard throttle. The methods and variables implemented in the class are straightforward. One thing to notice is that in the \cd+main.cpp+, when passing the cte error to calculate the total error, its third power is used. This has the effect to penalise more large cte and less cte.


\subsection{Kp, Kd, Ki}
The PID generates a control based on three components of the error. The three components are the error itself, its time derivative (i.e. the difference between the current error and the one at the previous error) and the integral component (i.e., the sum of all the errors or alternatively the sum in the last period). Each component is multiplied by a constant, respectively \cd+Kp+, \cd+Kd+ and \cd+Ki+. 

\subsection{PID class}
Each time a new error is received, the method \cd+PID::UpdateError+ is called. This updates the three components described previously that in the class are called respectively \cd+PID::d_error+, \cd+PID::p_error+ and \cd+PID::i_error+. To prevent the \cd+i_error+ term to continuously increasing, a counter variable has been defined.

The control signal is generated by the function which sums up each error component taken with opposite sign, multiplied by the proper constant. The \cd+i_error+ is divided by the \cd+counter+ variable to get its average.

\section{Twiddle algorithm}
To fine tune the parameters the twiddle algorithm has been implemented. This was done by declaring a new class. To keep the functionalities of the PID, inheritance has been used: The \cd+Twiddle+ class has been defined as a child class of \cd+PID+ and the \cd+Init+ and \cd+TotalError+ methods overridden. For this reason these were declared as virtual in the parent class.

\subsection{dKp, dKd, dKi}
These variables represent the amount to be added or subtracted when updating \cd+Kp+, \cd+Kd+ and \cd+Ki+. The algorithm is considered tuned when their sum is less than a given quantity and this check is implemented in the \cd+checkTuningCondition+.

\subsection{Twiddle algorithm and state machine}
The steps of the twiddle algorithm is implemented in the \cd+TotalError+ method by using a state machine. The following states are defined:
\begin{itemize}
\item \cd+initialising+: at first the algorithm is let run to for the given number of iterations to get a first error;
\item \cd+increment_tuning+: this state corresponds to the case where the next constant needs to be incremented by the corresponding \cd+dK+ variable;
\item \cd+increment_tuning+: this state corresponds to the case where the next constant needs to be decremented by the corresponding \cd+dK+ variable;
\item \cd+increment_tuning+: after the algorithm has run, the three parameters are fixed and need not changed.
\end{itemize}
For each state the algorithm runs for a given number of steps eventually change to the next state.

After the first state represented by \cd+initialising+ has determined the the first error, the \cd+state+ is set to \cd+increment_tuning+ and the first \cd+K+ variable is increased (the algorithm starts with \cd+Kp+). If the obtained error is less than the previously obtained ones, then the next \cd+K+ is going to be updated at the next iteration, otherwise the algorithm tries to decrement the current \cd+K+. If neither of the two improves the error, then for the moment the current \cd+K+ value is kept, the amount for the increment and decrement is reduced by $10\%$ and the next variable is going to be updated.

At the end of each iteration, the next parameter to be updated and the corresponding update amount is obtained by using an instance variable named \cd+paramToBeUpdated+ and the methods \cd+getK+, \cd+getdK+, \cd+setK+ and \cd+setdK+ allow to get and set these values.

\subsection{Automatically reset}
The \cd+Twiddle+ class has a  \cd+uWS::WebSocket<uWS::SERVER> *ws+ variable used to reset the run. The run is reset if the speed is close to $0$ (for example when the car gets stacked) or when the \cd+current_error+ gets bigger than the \cd+best_error+ before completing all the steps. This is done by sending a proper message through the websocket. The instance method to do that is \cd+reset+.

\section{Increase throttle}
After a the Twiddle found some good values, the throttle was increased and the algorithm rerun. Locally, I have managed to run with a throttle of $0.7$.

\section{Next}
The next thing to be done is to create a PID for the throttle.


\end{document}